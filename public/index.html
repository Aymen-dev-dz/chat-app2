<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Chat ACROW DZ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #9ab8f3;
      color: #fff;
      overflow: hidden;
    }
    canvas { 
      position: fixed; 
      top: 0; left: 0; 
      z-index: -1; 
    }

    /* Login */
    #login, #chat { position: relative; z-index: 2; }
    #login {
      display: flex; height: 100vh;
      align-items: center; justify-content: center;
    }
    #login div {
      background: rgba(255,255,255,0.05);
      padding: 50px; border-radius: 16px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      width: 320px;
    }
    #login h2 {
      margin-bottom: 25px;
      font-size: 1.8rem;
      background: linear-gradient(90deg, #d50000, #004aad);
      -webkit-background-clip: text; 
      background-clip: text;         
      -webkit-text-fill-color: transparent;   
      text-align: center;
    }
    #login input, #login button {
      padding: 14px;
      border: none; border-radius: 12px;
      font-size: 1rem;
    }
    #login input {
      margin-bottom: 15px; width: 100%;
      text-align: center;
      outline: none;
      background: rgba(255,255,255,0.15);
      color: #fff;
      transition: 0.3s;
    }
    #login input:focus { background: rgba(255,255,255,0.25); }
    #login button {
      width: 100%;
      background: linear-gradient(90deg,#d50000,#004aad);
      color: white; cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    #login button:hover { transform: scale(1.05); }

    /* Chat */
    #chat {
      display: none;
      height: 100vh;
      display: flex;
    }

    .sidebar {
      width: 280px;
      background:transparent;
      border-right: 2px solid rgba(255,255,255,0.1);
      padding: 20px;
      display: flex; flex-direction: column;
    }
    .sidebar h3 {
      margin-bottom: 15px;
      color: #00bfff;
      font-size: 1.2rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 8px;
    }
    .sidebar ul {
      list-style: none; padding: 0; margin: 0; flex: 1;
      overflow-y: auto;
    }
    .sidebar li {
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 8px;
      color: #ddd;
      display: flex; align-items: center;
      gap: 10px;
      transition: 0.3s;
    }
    .sidebar li:hover { background: rgba(255,255,255,0.1); }

    .user-avatar {
      width: 28px; height: 28px;
      border-radius: 50%; background: #00bfff;
      display: inline-block;
      text-align: center;
      line-height: 28px;
      font-size: 0.9rem;
      font-weight: bold;
      color: #fff;
    }

    .main {
      flex: 1; display: flex; flex-direction: column;
      background: transparent;
      backdrop-filter: blur(6px);
    }
    .messages {
      flex: 1; padding: 20px;
      overflow-y: auto;
      scrollbar-width: thin;
    }
    .messages li {
      margin-bottom: 12px;
      padding: 14px 18px;
      border-radius: 16px;
      max-width: 70%;
      word-wrap: break-word;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn { from {opacity:0; transform: translateY(5px);} to {opacity:1;} }

    .system {
      text-align: center; color: #aaa;
      font-size: 0.85em; font-style: italic;
    }
    .me {
      background: linear-gradient(135deg,#004aad,#007bff);
      color: white; margin-left: auto;
      box-shadow: 0 3px 10px rgba(110, 61, 61, 0.4);
    }
    .other {
      background: linear-gradient(135deg,#d50000,#ff4757);
      color: white; margin-right: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.4);
    }

    form {
      display: flex; border-top: 1px solid rgba(255,255,255,0.1);
      align-items: center; padding: 12px;
      background: rgba(0,0,0,0.5);
    }
    input[type="text"] {
      flex: 1; padding: 12px 16px;
      border: none; border-radius: 12px;
      margin-right: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      outline: none;
    }
    input[type="text"]::placeholder { color: #aaa; }
    label {
      cursor: pointer;
      padding: 10px 14px;
      background: #00bfff;
      color: white;
      border-radius: 12px;
      margin-right: 10px;
      font-size: 1.3rem;
      transition: 0.3s;
    }
    label:hover { background: #009acd; }
    button {
      background: linear-gradient(90deg,#d50000,#004aad);
      color: white; border: none;
      padding: 12px 20px;
      cursor: pointer; border-radius: 12px;
      font-weight: bold;
      transition: 0.3s;
    }
    button:hover { opacity: 0.85; }

    img { max-width: 220px; border-radius: 12px; margin-top: 6px; display: block; }

    /* Scrollbars */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(0,191,255,0.4); border-radius: 8px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,191,255,0.7); }
  </style>
</head>
<body>

  <canvas id="bg"></canvas>

  <!-- Login -->
  <div id="login">
    <div>
      <h2>Bienvenue sur ACROW DZ Chat</h2>
      <input id="username" placeholder="Ton pseudo..." />
      <button onclick="joinChat()">Entrer</button>
    </div>
  </div>

  <!-- Chat -->
  <div id="chat">
    <div class="sidebar">
      <h3>ðŸ‘¥ Utilisateurs</h3>
      <ul id="users"></ul>
    </div>
    <div class="main">
      <ul class="messages" id="messages"></ul>
      <form id="form">
        <input id="input" type="text" placeholder="Ã‰cris un message..." />
        <label for="fileInput">ðŸ“Ž</label>
        <input type="file" id="fileInput" style="display:none" />
        <button>Envoyer</button>
      </form>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script>
    const socket = io();
    let username = null;

    function joinChat() {
      const inputName = document.getElementById("username").value.trim();
      if (inputName) {
        username = inputName;
        socket.emit("set username", username);
        document.getElementById("login").style.display = "none";
        document.getElementById("chat").style.display = "flex";
      }
    }

    const form = document.getElementById("form");
    const input = document.getElementById("input");
    const messages = document.getElementById("messages");
    const usersList = document.getElementById("users");
    const fileInput = document.getElementById("fileInput");

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      if (input.value.trim() !== "") {
        socket.emit("chat message", input.value.trim());
        input.value = "";
      }
    });

    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) {
        const formData = new FormData();
        formData.append("file", file);
        fetch("/upload", { method: "POST", body: formData })
          .then(res => res.json())
          .then(data => {
            socket.emit("chat file", { user: username, fileUrl: data.url, fileName: file.name });
          });
      }
    });

    socket.on("chat message", (data) => {
      const item = document.createElement("li");
      if (data.user === "System") {
        item.className = "system";
        item.textContent = data.text;
      } else if (data.user === username) {
        item.className = "me";
        item.textContent = data.text;
      } else {
        item.className = "other";
        item.textContent = `${data.user}: ${data.text}`;
      }
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on("chat file", (data) => {
      const item = document.createElement("li");
      item.className = (data.user === username) ? "me" : "other";

      if (/\.(jpg|jpeg|png|gif)$/i.test(data.fileName)) {
        item.innerHTML = `<b>${data.user}:</b><br><img src="${data.fileUrl}">`;
      } else {
        item.innerHTML = `<b>${data.user}:</b> <a href="${data.fileUrl}" target="_blank">ðŸ“Ž ${data.fileName}</a>`;
      }
      messages.appendChild(item);
      messages.scrollTop = messages.scrollHeight;
    });

    socket.on("user list", (users) => {
      usersList.innerHTML = "";
      users.forEach(u => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="user-avatar">${u.charAt(0).toUpperCase()}</span>${u}`;
        usersList.appendChild(li);
      });
    });

    
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("bg"), alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const particleCount = 600;
    const geometry = new THREE.BufferGeometry();
    const positions = [];
    const colors = [];
    const colorChoices = [0xd50000, 0xffffff, 0x004aad];

    for (let i=0;i<particleCount;i++){
      positions.push((Math.random()-0.5)*20);
      positions.push((Math.random()-0.5)*20);
      positions.push((Math.random()-0.5)*20);
      const c = new THREE.Color(colorChoices[Math.floor(Math.random()*3)]);
      colors.push(c.r,c.g,c.b);
    }

    geometry.setAttribute("position", new THREE.Float32BufferAttribute(positions,3));
    geometry.setAttribute("color", new THREE.Float32BufferAttribute(colors,3));

    const material = new THREE.PointsMaterial({ size: 0.08, vertexColors:true, transparent:true, opacity:0.9 });
    const points = new THREE.Points(geometry, material);
    scene.add(points);

    camera.position.z = 10;

    const lineMaterial = new THREE.LineBasicMaterial({ color: 0xffffff, transparent:true, opacity:0.08 });
    const maxDistance = 1.5;
    let lineMesh = null;

    function animate(){
      requestAnimationFrame(animate);

      points.rotation.y += 0.0015;
      points.rotation.x += 0.0007;

      const pos = geometry.attributes.position.array;
      const linePositions = [];

      for(let i=0;i<particleCount;i++){
        const xi=pos[i*3], yi=pos[i*3+1], zi=pos[i*3+2];
        for(let j=i+1;j<particleCount;j++){
          const xj=pos[j*3], yj=pos[j*3+1], zj=pos[j*3+2];
          const dx=xi-xj, dy=yi-yj, dz=zi-zj;
          const dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
          if(dist<maxDistance){
            linePositions.push(xi,yi,zi,xj,yj,zj);
          }
        }
      }

      if(lineMesh) scene.remove(lineMesh);
      const lineGeom = new THREE.BufferGeometry();
      lineGeom.setAttribute("position", new THREE.Float32BufferAttribute(linePositions,3));
      lineMesh = new THREE.LineSegments(lineGeom,lineMaterial);
      scene.add(lineMesh);

      renderer.render(scene,camera);
    }

    animate();

    window.addEventListener("resize", ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>

